# Envoy Proxy Configuration for Local LLM Infrastructure
# Generated by nix/llm-config.nix
#
# Architecture:
#   Port 4001 (Envoy Gateway) → Routes to:
#     /v1/embeddings  → localhost:8001 (Qwen3-Embedding-8B)
#     /v1/rerank      → localhost:8002 (BGE-Reranker-v2-m3)
#     /v1/chat/*      → localhost:8000 (Devstral-2-123B)
#     /v1/completions → localhost:8000 (Devstral-2-123B)
#     /health         → localhost:8000 (health check)
#
# Supported OpenAI-compatible aliases:
#   Chat:       gpt-4, gpt-4-turbo, gpt-4o, gpt-3.5-turbo, claude-3-opus, claude-3-sonnet, devstral, devstral-2, mistral-large, devstral, devstral2, mistral-coder
#   Embeddings: text-embedding-ada-002, text-embedding-3-small, text-embedding-3-large, qwen3-embed
#   Reranking:  rerank-english-v3.0, rerank-multilingual-v3.0, bge-reranker, rerank

admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901

static_resources:
  listeners:
  - name: llm_gateway
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 4001
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          stat_prefix: llm_gateway
          codec_type: AUTO

          # Increase timeouts for LLM inference
          stream_idle_timeout: 600s
          request_timeout: 600s

          access_log:
          - name: envoy.access_loggers.stdout
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog

          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

          route_config:
            name: llm_routes
            virtual_hosts:
            - name: llm_services
              domains: ["*"]
              routes:
              # Embeddings → embedding backend
              - match:
                  prefix: "/v1/embeddings"
                route:
                  cluster: llama_embed
                  timeout: 120s

              # Reranking → reranking backend
              - match:
                  prefix: "/v1/rerank"
                route:
                  cluster: llama_rerank
                  timeout: 60s

              # Alternate rerank endpoint
              - match:
                  prefix: "/rerank"
                route:
                  cluster: llama_rerank
                  timeout: 60s

              # Chat completions → chat backend
              - match:
                  prefix: "/v1/chat"
                route:
                  cluster: llama_chat
                  timeout: 600s

              # Legacy completions → chat backend
              - match:
                  prefix: "/v1/completions"
                route:
                  cluster: llama_chat
                  timeout: 600s

              # Models list → chat backend
              - match:
                  prefix: "/v1/models"
                route:
                  cluster: llama_chat
                  timeout: 10s

              # Health check → chat backend
              - match:
                  prefix: "/health"
                route:
                  cluster: llama_chat
                  timeout: 5s

              # Default catch-all → chat backend
              - match:
                  prefix: "/"
                route:
                  cluster: llama_chat
                  timeout: 600s

  clusters:
  # Chat/Completions backend (Devstral-2-123B)
  - name: llama_chat
    type: STATIC
    connect_timeout: 5s
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: llama_chat
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8000

  # Embedding backend (Qwen3-Embedding-8B)
  - name: llama_embed
    type: STATIC
    connect_timeout: 5s
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: llama_embed
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8001

  # Reranking backend (BGE-Reranker-v2-m3)
  - name: llama_rerank
    type: STATIC
    connect_timeout: 5s
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: llama_rerank
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: 127.0.0.1
                port_value: 8002

